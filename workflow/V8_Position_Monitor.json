{
  "name": "V8.0 æŠ•åç›¯ç›˜å·¥ä½œæµ",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "10 15 * * 1-5"
            }
          ]
        }
      },
      "id": "75963dc7-7b04-46eb-9ad9-ab174c12b102",
      "name": "æ¯æ—¥15:10è§¦å‘ (å·¥ä½œæ—¥)",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        -2640,
        176
      ]
    },
    {
      "parameters": {
        "resource": "bitable",
        "operation": "bitable:table:record:search",
        "app_toke": "RVghbRvYgacqs3s82qkcl83bn7e",
        "table_id": "tblKGT8D4rDur8Gi",
        "page_size": 100,
        "body": "{\n  \"filter\": {\n    \"conjunction\": \"and\",\n    \"conditions\": [\n      {\n        \"field_name\": \"æŒä»“çŠ¶æ€\",\n        \"operator\": \"is\",\n        \"value\": [\"æŒä»“\"]\n      }\n    ]\n  }\n}"
      },
      "id": "5a299a16-78aa-4c5c-bfdc-8928c7c09d61",
      "name": "è¯»å–é£ä¹¦ã€æŒä»“ç®¡ç†ã€‘",
      "type": "n8n-nodes-feishu-lite.feishuNode",
      "typeVersion": 1,
      "position": [
        -2416,
        176
      ],
      "alwaysOutputData": true,
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetweenTries": 2000,
      "credentials": {
        "feishuCredentialsApi": {
          "id": "RcP0KB4O5l2Y95Bs",
          "name": "Feishu account 2"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// è½¬æ¢é£ä¹¦è®°å½•ä¸º API è¯·æ±‚æ ¼å¼\nconst items = $input.all();\n\n// è¾…åŠ©å‡½æ•°ï¼šæå–é£ä¹¦å­—æ®µå€¼ï¼ˆå¤„ç†å¯Œæ–‡æœ¬æ ¼å¼ï¼‰\nfunction extractValue(field) {\n    if (!field) return '';\n    // å¦‚æœæ˜¯æ•°ç»„ï¼ˆå¯Œæ–‡æœ¬æ ¼å¼ï¼‰ï¼Œæå–ç¬¬ä¸€ä¸ªå…ƒç´ çš„text\n    if (Array.isArray(field)) {\n        return field[0]?.text || field[0] || '';\n    }\n    // å¦‚æœæ˜¯å¯¹è±¡ï¼ˆå•é€‰æ ¼å¼ï¼‰ï¼Œæå–textæˆ–value\n    if (typeof field === 'object') {\n        return field.text || field.value || String(field);\n    }\n    // æ™®é€šå€¼ç›´æ¥è¿”å›\n    return String(field);\n}\n\n// æ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®\nif (!items || items.length === 0 || !items[0].json.data?.items) {\n    console.log('âš ï¸ æ— æŒä»“æ•°æ®');\n    return [{ json: { positions: [], total: 0 } }];\n}\n\nconst records = items[0].json.data.items;\nconst positions = records.map(item => {\n  const fields = item.fields || {};\n  return {\n    code: extractValue(fields['ä»£ç ']),\n    market: extractValue(fields['å¸‚åœº']) || 'CN',\n    buy_price: parseFloat(fields['ä¹°å…¥ä»·']) || 0,\n    current_stop: parseFloat(fields['å½“å‰æ­¢æŸ']) || 0,\n    target_price: parseFloat(fields['ç›®æ ‡ä»·']) || 0,\n    shares: parseInt(fields['ä¹°å…¥æ‰‹æ•°']) || 0,\n    record_id: item.record_id || ''\n  };\n}).filter(p => p.code);\n\nconsole.log(`ğŸ“Š Found ${positions.length} positions to check`);\nreturn [{ json: { positions, total: positions.length } }];"
      },
      "id": "5612ad77-cd97-4899-be09-6dc28b710c07",
      "name": "è½¬æ¢æ•°æ®æ ¼å¼",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2192,
        176
      ],
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://jpthermjdexc.ap-northeast-1.clawcloudrun.com/check_positions",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json) }}",
        "options": {
          "timeout": 120000
        }
      },
      "id": "a8bbfb9e-22d8-42c2-84cf-03bf86b2d97e",
      "name": "è°ƒç”¨ /check_positions",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        -1968,
        176
      ],
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetweenTries": 2000,
      "alwaysOutputData": true,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "fieldToSplitOut": "positions",
        "options": {}
      },
      "id": "2a77bcc7-2f9f-4c12-b932-4151f2994bf4",
      "name": "æ‹†åˆ†æ£€æŸ¥ç»“æœ",
      "type": "n8n-nodes-base.splitOut",
      "typeVersion": 1,
      "position": [
        -1760,
        176
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "sell-check",
              "leftValue": "={{ $json.action }}",
              "rightValue": "SELL",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "id": "3a31c405-c723-4176-89d6-bbd71fa6301c",
      "name": "æ˜¯å¦éœ€è¦å–å‡º?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -1536,
        176
      ]
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// æ„å»ºå–å‡ºé€šçŸ¥å¡ç‰‡\nconst data = $json;\nconst action = data.action || 'UNKNOWN';\n\nlet color = 'grey';\nlet emoji = 'ğŸ“Š';\nlet title = 'äº¤æ˜“æé†’';\n\nif (action === 'SELL_STOP') {\n    color = 'red';\n    emoji = 'ğŸ”´';\n    title = `${emoji} æ­¢æŸè­¦æŠ¥: ${data.code}`;\n} else if (action === 'SELL_TARGET') {\n    color = 'green';\n    emoji = 'ğŸŸ¢';\n    title = `${emoji} æ­¢ç›ˆè¾¾æ ‡: ${data.code}`;\n}\n\nconst cardContent = [\n  {\n    tag: 'div',\n    text: {\n      tag: 'lark_md',\n      content: `**ç°ä»·**: ${data.current_price}\\n**åŸå› **: ${data.reason}\\n**æ”¶ç›Šç‡**: ${data.pnl_percent}%`\n    }\n  },\n  { tag: 'hr' },\n  {\n    tag: 'div',\n    text: {\n      tag: 'lark_md',\n      content: action === 'SELL_STOP' ? 'âš ï¸ **å»ºè®®ç«‹å³å–å‡ºæ­¢æŸ**' : 'ğŸ¯ **æ­å–œè¾¾åˆ°ç›®æ ‡ä»·ï¼**'\n    }\n  }\n];\n\nreturn {\n  json: {\n    card_color: color,\n    card_content: cardContent,\n    header_title: title\n  }\n};"
      },
      "id": "b11337b1-ecfd-4b2f-8d7f-1eef397b921c",
      "name": "æ„å»ºå–å‡ºé€šçŸ¥å¡ç‰‡",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1312,
        64
      ],
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "resource": "message",
        "operation": "message:send",
        "receive_id_type": "user_id",
        "receive_id": "bg99a8dc",
        "msg_type": "interactive",
        "content": "={{\nJSON.stringify({\n  \"config\": {\n    \"wide_screen_mode\": true\n  },\n  \"header\": {\n    \"template\": $json.card_color,\n    \"title\": {\n      \"content\": $json.header_title,\n      \"tag\": \"plain_text\"\n    }\n  },\n  \"elements\": $json.card_content\n})\n}}"
      },
      "id": "e729495d-0723-4f34-80f7-86a178fd4364",
      "name": "å‘é€å–å‡ºé€šçŸ¥",
      "type": "n8n-nodes-feishu-lite.feishuNode",
      "typeVersion": 1,
      "position": [
        -1088,
        64
      ],
      "alwaysOutputData": true,
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetweenTries": 2000,
      "credentials": {
        "feishuCredentialsApi": {
          "id": "RcP0KB4O5l2Y95Bs",
          "name": "Feishu account 2"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// æ„å»ºæŒæœ‰é€šçŸ¥å¡ç‰‡\nconst data = $json;\n\nlet updateInfo = '';\nif (data.new_stop && data.new_stop > 0) {\n    updateInfo = `\\nğŸ“ˆ **æ–°æ­¢æŸä»·**: ${data.new_stop} (å·²ä¸Šè°ƒ)`;\n}\n\nconst cardContent = [\n  {\n    tag: 'div',\n    text: {\n      tag: 'lark_md',\n      content: `**è‚¡ç¥¨**: ${data.code}\\n**ç°ä»·**: ${data.current_price}\\n**æ”¶ç›Šç‡**: ${data.pnl_percent}%${updateInfo}`\n    }\n  },\n  { tag: 'hr' },\n  {\n    tag: 'div',\n    text: {\n      tag: 'lark_md',\n      content: `${data.reason || 'ç»§ç»­æŒæœ‰'}`\n    }\n  }\n];\n\nreturn {\n  json: {\n    card_color: 'blue',\n    card_content: cardContent,\n    header_title: `â³ æŒæœ‰ä¸­: ${data.code}`\n  }\n};"
      },
      "id": "66fd5d8a-cc07-438a-b512-aa9e9b0d1762",
      "name": "æ„å»ºæŒæœ‰é€šçŸ¥å¡ç‰‡",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1312,
        272
      ],
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "resource": "message",
        "operation": "message:send",
        "receive_id_type": "user_id",
        "receive_id": "bg99a8dc",
        "msg_type": "interactive",
        "content": "={{\nJSON.stringify({\n  \"config\": {\n    \"wide_screen_mode\": true\n  },\n  \"header\": {\n    \"template\": $json.card_color,\n    \"title\": {\n      \"content\": $json.header_title,\n      \"tag\": \"plain_text\"\n    }\n  },\n  \"elements\": $json.card_content\n})\n}}"
      },
      "id": "e9b839a4-790f-42be-aec6-696b2dc9043c",
      "name": "å‘é€æŒæœ‰é€šçŸ¥",
      "type": "n8n-nodes-feishu-lite.feishuNode",
      "typeVersion": 1,
      "position": [
        -1088,
        272
      ],
      "alwaysOutputData": true,
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetweenTries": 2000,
      "credentials": {
        "feishuCredentialsApi": {
          "id": "RcP0KB4O5l2Y95Bs",
          "name": "Feishu account 2"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "stop-update-check",
              "leftValue": "={{ $('æ‹†åˆ†æ£€æŸ¥ç»“æœ').item.json.new_stop }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "check-stop-update-001",
      "name": "æ­¢æŸæ˜¯å¦éœ€è¦æ›´æ–°?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -864,
        272
      ]
    },
    {
      "parameters": {
        "resource": "bitable",
        "operation": "bitable:table:record:update",
        "app_toke": "RVghbRvYgacqs3s82qkcl83bn7e",
        "table_id": "tblKGT8D4rDur8Gi",
        "record_id": "={{ $('æ‹†åˆ†æ£€æŸ¥ç»“æœ').item.json.record_id }}",
        "body": "={{ JSON.stringify({ \"fields\": { \"å½“å‰æ­¢æŸ\": $('æ‹†åˆ†æ£€æŸ¥ç»“æœ').item.json.new_stop, \"ç›ˆäºæ¯”ä¾‹\": $('æ‹†åˆ†æ£€æŸ¥ç»“æœ').item.json.pnl_percent / 100, \"ç›ˆäºé‡‘é¢\": $('æ‹†åˆ†æ£€æŸ¥ç»“æœ').item.json.pnl_amount, \"ç°ä»·\": $('æ‹†åˆ†æ£€æŸ¥ç»“æœ').item.json.current_price } }) }}"
      },
      "id": "update-stop-loss-001",
      "name": "æ›´æ–°æ­¢æŸä»·åˆ°é£ä¹¦",
      "type": "n8n-nodes-feishu-lite.feishuNode",
      "typeVersion": 1,
      "position": [
        -640,
        180
      ],
      "alwaysOutputData": true,
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetweenTries": 2000,
      "credentials": {
        "feishuCredentialsApi": {
          "id": "RcP0KB4O5l2Y95Bs",
          "name": "Feishu account 2"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {},
      "id": "no-update-needed-001",
      "name": "æ­¢æŸæ— éœ€æ›´æ–°",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        -640,
        360
      ]
    }
  ],
  "pinData": {},
  "connections": {
    "æ¯æ—¥15:10è§¦å‘ (å·¥ä½œæ—¥)": {
      "main": [
        [
          {
            "node": "è¯»å–é£ä¹¦ã€æŒä»“ç®¡ç†ã€‘",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "è¯»å–é£ä¹¦ã€æŒä»“ç®¡ç†ã€‘": {
      "main": [
        [
          {
            "node": "è½¬æ¢æ•°æ®æ ¼å¼",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "è½¬æ¢æ•°æ®æ ¼å¼": {
      "main": [
        [
          {
            "node": "è°ƒç”¨ /check_positions",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "è°ƒç”¨ /check_positions": {
      "main": [
        [
          {
            "node": "æ‹†åˆ†æ£€æŸ¥ç»“æœ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æ‹†åˆ†æ£€æŸ¥ç»“æœ": {
      "main": [
        [
          {
            "node": "æ˜¯å¦éœ€è¦å–å‡º?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æ˜¯å¦éœ€è¦å–å‡º?": {
      "main": [
        [
          {
            "node": "æ„å»ºå–å‡ºé€šçŸ¥å¡ç‰‡",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "æ„å»ºæŒæœ‰é€šçŸ¥å¡ç‰‡",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æ„å»ºå–å‡ºé€šçŸ¥å¡ç‰‡": {
      "main": [
        [
          {
            "node": "å‘é€å–å‡ºé€šçŸ¥",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æ„å»ºæŒæœ‰é€šçŸ¥å¡ç‰‡": {
      "main": [
        [
          {
            "node": "å‘é€æŒæœ‰é€šçŸ¥",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "å‘é€æŒæœ‰é€šçŸ¥": {
      "main": [
        [
          {
            "node": "æ­¢æŸæ˜¯å¦éœ€è¦æ›´æ–°?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æ­¢æŸæ˜¯å¦éœ€è¦æ›´æ–°?": {
      "main": [
        [
          {
            "node": "æ›´æ–°æ­¢æŸä»·åˆ°é£ä¹¦",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "æ­¢æŸæ— éœ€æ›´æ–°",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "v8.0-position-monitor-v5-auto-stoploss",
  "meta": {
    "instanceId": "2f742d99bafc29685192c328e0fdaa64b8db6ce3b25050806eb96df939878538"
  },
  "id": "tPdxaYo0ZfhJe3xl",
  "tags": []
}