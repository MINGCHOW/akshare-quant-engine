{
  "name": "AH Stock V9.3 Titan (Full Optimized)",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "30 17 * * 1-5"
            }
          ]
        }
      },
      "id": "55eff146-43cc-4116-9834-ae202706431f",
      "name": "å®šæ—¶è§¦å‘_å·¥ä½œæ—¥17:30(åŒ—äº¬æ—¶é—´)",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        14112,
        7232
      ]
    },
    {
      "parameters": {
        "url": "https://jpthermjdexc.ap-northeast-1.clawcloudrun.com/market",
        "options": {}
      },
      "id": "40451dc7-5de4-40ca-908a-a7f263b4afba",
      "name": "Global Context (API)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        14320,
        7232
      ],
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetweenTries": 5000
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "https://docs.google.com/spreadsheets/d/1_MqQPC5DzLTarOM4hJ9_ajUX20piCiD6YmeM6Cp5Iys/edit?gid=0#gid=0",
          "mode": "url"
        },
        "sheetName": {
          "__rl": true,
          "value": "stock list",
          "mode": "name"
        },
        "options": {}
      },
      "id": "94d0eb6e-eb6a-4a48-b279-99e1c38affe7",
      "name": "è¯»å–è‚¡ç¥¨åˆ—è¡¨",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        14512,
        7232
      ],
      "alwaysOutputData": true,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "OKN7AHfMulimnqoc",
          "name": "Google Sheets account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "\n// 1. è·å–æ‰€æœ‰è‚¡ç¥¨æ•°æ®\nconst items = $('è¯»å–è‚¡ç¥¨åˆ—è¡¨').all();\n\n// 2. åˆå§‹åŒ–å…¨å±€æ¸¸æ ‡\nlet staticData;\ntry {\n    staticData = getWorkflowStaticData('global');\n} catch(e) {\n    try {\n        staticData = $getWorkflowStaticData('global');\n    } catch(e2) {\n        console.log(\"Error getting static data: \" + e2.message);\n        throw new Error(\"Unable to access getWorkflowStaticData. Ensure Code Node Mode is 'Run Once for All Items'.\");\n    }\n}\n\nstaticData.nextIndex = 0;\nstaticData.total = items.length;\nstaticData.stockList = items.map(idx => idx.json);\n\nconsole.log(`Initialized Manual Loop. Total items: ${items.length}`);\nreturn { json: { status: \"Loop Initialized\", total: items.length } };\n"
      },
      "id": "39c6f8ee-d50e-42eb-adca-09096f42d445",
      "name": "åˆå§‹åŒ–å¾ªç¯",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        14720,
        7232
      ]
    },
    {
      "parameters": {
        "jsCode": "\nlet staticData;\ntry {\n    staticData = getWorkflowStaticData('global');\n} catch(e) {\n    staticData = $getWorkflowStaticData('global');\n}\n\nconst idx = staticData.nextIndex || 0;\nconst list = staticData.stockList;\n\nif (idx >= list.length) {\n    console.log(\"âœ… Loop Finished. Total processed: \" + list.length);\n    return null;\n}\n\nconst currentStock = list[idx];\nconst progress = Math.round((idx + 1) / list.length * 100);\nconsole.log(`â³ Processing [${idx + 1}/${list.length}] (${progress}%): ${currentStock.code}`);\n\nstaticData.nextIndex = idx + 1;\n\nreturn { json: currentStock };\n"
      },
      "id": "885e6f5c-0997-48d5-aeff-f0e2183f6b7b",
      "name": "æ‰‹å·¥å¾ªç¯æ§åˆ¶å™¨",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        14912,
        7232
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://jpthermjdexc.ap-northeast-1.clawcloudrun.com/analyze_full",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "code",
              "value": "={{ $json.code }}"
            },
            {
              "name": "balance",
              "value": "={{ $json.balance || 100000 }}"
            },
            {
              "name": "risk",
              "value": "={{ $json.risk || 0.01 }}"
            }
          ]
        },
        "options": {
          "timeout": 90000
        }
      },
      "id": "af3356bf-db33-4e28-8d92-522b8e40717f",
      "name": "Full Stack Analysis (API V9)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        15120,
        7232
      ],
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetweenTries": 2000,
      "alwaysOutputData": true,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.tavily.com/search",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "api_key",
              "value": "={{ $env.TAVILY_API_KEY || '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' }}"
            },
            {
              "name": "query",
              "value": "={{ $json.name }} æœ€æ–°æ–°é—» åˆ©å¥½ åˆ©ç©º"
            },
            {
              "name": "include_answer",
              "value": "basic"
            }
          ]
        },
        "options": {
          "timeout": 15000
        }
      },
      "id": "b42af4c2-8af1-419c-a636-114b3fe69ddb",
      "name": "Tavilyæ–°é—»æœç´¢",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        15312,
        7232
      ],
      "alwaysOutputData": true,
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetweenTries": 2000,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// V9.3 Fix: ä» API èŠ‚ç‚¹è¯»å–åˆ†ææ•°æ®\nconst data = $('Full Stack Analysis (API V9)').first().json;\nconst marketStatus = $('Global Context (API)').first().json.market_status || \"Unknown\"; \n\nlet isError = false;\nlet errorMsg = \"\";\n\nif (data.error) {\n    isError = true;\n    errorMsg = JSON.stringify(data.error);\n} else if (!data.technical) {\n    isError = true;\n    errorMsg = \"API V9 returned no technical data (8-Layer Exhaustion).\";\n}\n\nif (isError) {\n    return {\n        json: {\n            prompt: `System Error Alert: The analysis API failed for stock ${data.code || 'unknown'}. Error: ${errorMsg}. Please generate a short report stating that data acquisition failed and human review is needed.`,\n            raw_data: data,\n            is_error: true\n        }\n    };\n}\n\nconst tech = data.technical || {};\nconst sig = data.signal || {};\nconst risk = data.risk_ctrl || {};\n\n// ä»å½“å‰èŠ‚ç‚¹è·å– Tavily æ–°é—»æ•°æ®\nlet news_text = \"æœªæœç´¢åˆ°æ–°é—»\";\ntry {\n    const news = $json;  // å½“å‰èŠ‚ç‚¹æ”¶åˆ°çš„æ˜¯ Tavily è¾“å‡º\n    if (news.results) {\n        news_text = news.results.map(r => `- ${r.title}`).join('\\n');\n    } else if (news.answer) {\n        news_text = news.answer;\n    }\n} catch(e) {}\n\n// ==================== V9.3 ETF è¯†åˆ«é€»è¾‘ ====================\nlet etf_instruction = \"\";\nconst codeStr = String(data.code || '');\nconst market = data.market || 'CN';\n\n// æ¸¯è‚¡ETFè¯†åˆ« (0xxxx, 1xxxx, 5xxxx å¼€å¤´é€šå¸¸æ˜¯ETF)\nif (market === 'HK' && (codeStr.startsWith('0') || codeStr.startsWith('1') || codeStr.startsWith('5'))) {\n    etf_instruction = `\n\n### ğŸ“ˆ ETFç‰¹æ®Šå¤„ç†\nâš ï¸ è¿™æ˜¯**æ¸¯è‚¡ETF**ï¼Œç­–ç•¥åº”ä»¥è·Ÿè¸ªå¤§ç›˜æŒ‡æ•°ä¸ºä¸»ï¼Œé¿å…è¿‡åº¦äº¤æ˜“ã€‚\n- ä¼˜å…ˆåˆ†æå…¶è·Ÿè¸ªçš„åº•å±‚èµ„äº§èµ°åŠ¿ï¼ˆå¦‚æ’ç”ŸæŒ‡æ•°ã€çº³æŒ‡100ã€é»„é‡‘ã€ç™½é“¶ç­‰ï¼‰\n- ETFä¸é€‚åˆçŸ­çº¿é¢‘ç¹æ“ä½œï¼Œå»ºè®®ä¸­é•¿çº¿æŒæœ‰æˆ–æ³¢æ®µæ“ä½œ\n- æ­¢æŸå¯é€‚å½“æ”¾å®½ï¼Œä½†éœ€å…³æ³¨æŠ˜æº¢ä»·ç‡`;\n}\n// Aè‚¡ETFè¯†åˆ« (51xxxx, 15xxxx, 16xxxx å¼€å¤´)\nelse if (market === 'CN' && (codeStr.startsWith('51') || codeStr.startsWith('15') || codeStr.startsWith('16'))) {\n    etf_instruction = `\n\n### ğŸ“ˆ ETFç‰¹æ®Šå¤„ç†\nâš ï¸ è¿™æ˜¯**Aè‚¡ETF**ï¼Œè¯·é‡ç‚¹åˆ†æå…¶è·Ÿè¸ªçš„åº•å±‚æŒ‡æ•°æˆ–è¡Œä¸šæ¿å—èµ°åŠ¿ã€‚\n- é€‚åˆä½œä¸ºè¡Œä¸šé…ç½®å·¥å…·ï¼Œè€ŒéçŸ­çº¿æŠ•æœº\n- å…³æ³¨æˆäº¤é‡å’ŒæŠ˜æº¢ä»·ç‡\n- å¯ç»“åˆè¡Œä¸šè½®åŠ¨é€»è¾‘è¿›è¡Œæ³¢æ®µæ“ä½œ`;\n}\n// ==============================================================\n\nconst prompt = `# å†³ç­–ä»ªè¡¨ç›˜åˆ†æè¯·æ±‚ (Titan V9.3 Core)\n\n## è‚¡ç¥¨åŸºç¡€\n- ä»£ç : ${data.code} (${data.market})\n- å¤§ç›˜ç¯å¢ƒ: ${marketStatus}\n- ç°ä»·: ${tech.current_price}\n\n## ä¿¡å·ç³»ç»Ÿ (8-Layer Shield)\n- æ ¸å¿ƒä¿¡å·: ${sig.signal}\n- è¶‹åŠ¿è¯„åˆ†: ${sig.trend_score}/100\n- ç†ç”±: ${sig.signal_reasons ? sig.signal_reasons.join(', ') : 'æ— '}\n\n## é£æ§å‚æ•°\n- æ­¢æŸä»·: ${sig.stop_loss}\n- ç›®æ ‡ä»·: ${sig.take_profit}\n- ATRæ³¢åŠ¨: ${tech.atr14}\n- å»ºè®®ä»“ä½: ${risk.suggested_position} æ‰‹ (åŸºäº1%é£é™©)\n\n## æŠ€æœ¯æŒ‡æ ‡\n- MAæ’åˆ—: ${tech.ma_alignment} (${tech.ma5}/${tech.ma20})\n- EMAè¶‹åŠ¿: 13æ—¥çº¿ ${tech.ema13} vs 26æ—¥çº¿ ${tech.ema26}\n- ä¹–ç¦»ç‡: ${tech.bias_ma5}%\n- RSI(14): ${tech.rsi14}\n- é‡æ¯”: ${tech.volume_ratio}\n\n## æ–°é—»æ‘˜è¦\n${news_text}${etf_instruction}\n\nè¯·åŸºäºä»¥ä¸Šæ•°æ®ï¼Œç”¨ç®€ç»ƒçš„ä¸“ä¸šæœ¯è¯­ç”Ÿæˆäº¤æ˜“è®¡åˆ’ã€‚`;\n\nlet risk_instruction = \"\";\nif (marketStatus === 'Bear' || marketStatus === 'Crash') {\n    risk_instruction = `\n!!! ğŸ”´ ä¸¥é‡è­¦å‘Šï¼šå½“å‰å¤„äºç†Šå¸‚/æš´è·Œç¯å¢ƒ (${marketStatus}) !!!\n1. **ä¸¥æ ¼æ ‡å‡†**ï¼šä»…å…è®¸è¯„åˆ†>85ä¸”æœ‰é‡å¤§åˆ©å¥½çš„ä¸ªè‚¡æ“ä½œã€‚\n2. **å¼ºåˆ¶è½»ä»“**ï¼šå»ºè®®ä»“ä½å¿…é¡»å‡åŠï¼Œæˆ–è€…ç›´æ¥å»ºè®®ç©ºä»“ã€‚\n3. **å¯»æ‰¾åšç©ºæœºä¼š**ï¼šå¦‚æœæ˜¯æ¸¯è‚¡ï¼Œä¼˜å…ˆå¯»æ‰¾åšç©ºé€»è¾‘ï¼›å¦‚æœæ˜¯Aè‚¡ï¼Œå»ºè®®ä»¥\"è§‚æœ›\"ä¸ºä¸»ã€‚\n4. **æªè¾ä¸¥å‰**ï¼šè¯·åœ¨æ ¸å¿ƒç»“è®ºä¸­ç”¨ç²—ä½“å¼ºè°ƒå¤§ç›˜é£é™©ã€‚`;\n}\n\nreturn {\n    json: {\n        prompt: prompt + risk_instruction,\n        technical: tech, \n        raw_data: data,\n        is_etf: etf_instruction !== \"\"\n    }\n};"
      },
      "id": "86ca1e06-b870-4fc9-a915-ff6b302b1e06",
      "name": "æ„å»ºAIæç¤ºè¯",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        15504,
        7232
      ],
      "alwaysOutputData": true,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "modelName": "models/gemini-3-pro-image-preview",
        "options": {
          "maxOutputTokens": 2048,
          "temperature": 0.3
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        15520,
        7440
      ],
      "id": "cb8b1369-8c04-456d-a595-6d36e94dec75",
      "name": "Google Gemini Chat Model",
      "credentials": {
        "googlePalmApi": {
          "id": "V4cRtuj3j8gaQfEU",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.prompt }}",
        "options": {
          "systemMessage": "You are a professional Financial Analyst Agent (Titan V9.3 Edition). \nYour Role: Analyze stock data (Technical + Fundamental + News) and generate a clear, actionable trading plan in structured JSON format.\n\n### Input Data:\n- Technical Indicators (MA, RSI, ATR, etc.)\n- Signal Logic (V9.0 8-Layer Shield)\n- Market Context (Bull/Bear/Crash)\n- News Summary (Chinese)\n- ETF Detection (if applicable)\n\n### Language Requirement:\n- **JSON Keys**: MUST be in English (e.g. `analysis_summary`).\n- **Content Values**: MUST be in **Simplified Chinese (ç®€ä½“ä¸­æ–‡)** (e.g. `\"trend_prediction\": \"çœ‹æ¶¨\"`)\n\n### Output Requirement:\nReturn ONLY a valid JSON object. No markdown formatting, no code blocks (` ```json `), just the raw JSON.\n\n### JSON Schema:\n{\n  \"stock_name\": \"String\",\n  \"analysis_summary\": \"One sentence summary in Chinese\",\n  \"trend_prediction\": \"çœ‹æ¶¨/çœ‹è·Œ/ä¸­æ€§\",\n  \"sentiment_score\": 0-100,\n  \"decision_type\": \"buy/sell/hold/wait\",\n  \"operation_advice\": \"Clear instruction in Chinese\",\n  \"dashboard\": {\n    \"core_conclusion\": {\n      \"signal_type\": \"å¼ºçƒˆä¹°å…¥/ä¹°å…¥/è§‚æœ›/å–å‡º\",\n      \"one_sentence\": \"Detailed reasoning in Chinese...\",\n      \"position_advice\": {\n        \"no_position\": \"ç­‰å¾… / å¼€ä»“10%\",\n        \"has_position\": \"æŒæœ‰ / å‡ä»“ / æ¸…ä»“\"\n      }\n    },\n    \"battle_plan\": {\n      \"sniper_points\": {\n        \"ideal_buy\": 0.00,\n        \"stop_loss\": 0.00,\n        \"take_profit\": 0.00\n      },\n      \"checklist\": [\"å‡çº¿å¤šå¤´æ’åˆ—\", \"RSIæœªè¶…ä¹°\", \"é‡æ¯”æ­£å¸¸\"]\n    },\n    \"intelligence\": {\n      \"risk_alerts\": [\"é£é™©1\", \"é£é™©2\"],\n      \"sentiment_summary\": \"News analysis in Chinese...\"\n    }\n  }\n}\n\n### Example Output:\n{\n  \"stock_name\": \"è…¾è®¯æ§è‚¡\",\n  \"analysis_summary\": \"æŠ€æœ¯é¢åå¤šä½†å—å¤§ç›˜æ‹–ç´¯ï¼Œå»ºè®®è½»ä»“è§‚æœ›\",\n  \"trend_prediction\": \"ä¸­æ€§åå¤š\",\n  \"sentiment_score\": 62,\n  \"decision_type\": \"hold\",\n  \"operation_advice\": \"å¯å°ä»“ä½è¯•æ¢æ€§å¸ƒå±€ï¼Œä¸¥æ ¼æ­¢æŸ\",\n  \"dashboard\": {\n    \"core_conclusion\": {\n      \"signal_type\": \"è§‚æœ›\",\n      \"one_sentence\": \"çŸ­æœŸå‡çº¿é‡‘å‰ä½†é‡èƒ½ä¸è¶³ï¼Œç­‰å¾…æ”¾é‡ç¡®è®¤\",\n      \"position_advice\": {\n        \"no_position\": \"ç­‰å¾…çªç ´åå†å…¥åœº\",\n        \"has_position\": \"æŒæœ‰ï¼Œæ­¢æŸè®¾åœ¨æ”¯æ’‘ä½ä¸‹æ–¹\"\n      }\n    },\n    \"battle_plan\": {\n      \"sniper_points\": {\n        \"ideal_buy\": 380.00,\n        \"stop_loss\": 365.00,\n        \"take_profit\": 420.00\n      },\n      \"checklist\": [\"MA5>MA10 âœ“\", \"RSI 55 é€‚ä¸­\", \"é‡æ¯”0.8 åå¼±\"]\n    },\n    \"intelligence\": {\n      \"risk_alerts\": [\"å¤§ç›˜èµ°å¼±\", \"ç¾è”å‚¨åŠ æ¯é¢„æœŸ\"],\n      \"sentiment_summary\": \"è¿‘æœŸæ— é‡å¤§åˆ©å¥½åˆ©ç©ºï¼Œå¸‚åœºæƒ…ç»ªåè°¨æ…\"\n    }\n  }\n}\n\n### Rules:\n1. If Market is 'Bear' or 'Crash', be extremely conservative. Penalize score by 20 points.\n2. Stop Loss must be respected. If current price < stop loss, decision is SELL.\n3. NEVER use placeholder values (0.00) for stop_loss/take_profit. Calculate based on ATR.\n4. sentiment_score must reflect: technical (40%) + news (30%) + market context (30%).\n5. If data contains ETF info, adjust strategy for index-tracking instruments.\n6. Do not hallucinate data. Use provided numbers."
        }
      },
      "id": "82d30671-da51-49ce-8896-2657c4dd1eb5",
      "name": "AIåˆ†æAgent",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2,
      "position": [
        15664,
        7232
      ],
      "alwaysOutputData": true,
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetweenTries": 2000,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// ã€å…¨é€‰æ›¿æ¢ã€‘è§£æAIåˆ†æç»“æœ - V9.3 JSONè‡ªåŠ¨ä¿®å¤ç‰ˆ\nconst aiOutput = $json.output || $json.content || $json.response || $json;\n\n// ä» \"æ„å»ºAIæç¤ºè¯\" èŠ‚ç‚¹æ‰¾å›åŸå§‹æŠ€æœ¯æ•°æ®\nlet technical, rawData;\ntry {\n  const upstream = $('æ„å»ºAIæç¤ºè¯').last().json;\n  technical = upstream.technical || {};\n  rawData = upstream.raw_data || {};\n} catch (e) {\n  technical = $json.technical || {}; \n  rawData = $json.raw_data || {};\n}\n\n// ==================== V9.3 JSON è‡ªåŠ¨ä¿®å¤å‡½æ•° ====================\nfunction repairJSON(str) {\n  let s = str;\n  \n  // 1. ç§»é™¤ markdown ä»£ç å—\n  s = s.replace(/```json\\s*/gi, '').replace(/```\\s*/g, '');\n  \n  // 2. æå– JSON å¯¹è±¡\n  const jsonStart = s.indexOf('{');\n  const jsonEnd = s.lastIndexOf('}') + 1;\n  if (jsonStart >= 0 && jsonEnd > jsonStart) {\n    s = s.substring(jsonStart, jsonEnd);\n  }\n  \n  // 3. ä¿®å¤å¸¸è§é—®é¢˜\n  // 3.1 ç§»é™¤å°¾éƒ¨é€—å· (trailing commas)\n  s = s.replace(/,\\s*([\\]}])/g, '$1');\n  \n  // 3.2 ä¿®å¤æœªé—­åˆçš„å­—ç¬¦ä¸² (åœ¨è¡Œå°¾æ·»åŠ ç¼ºå¤±çš„å¼•å·)\n  s = s.replace(/:\\s*\"([^\"]*?)(\\n|$)/g, ': \"$1\"$2');\n  \n  // 3.3 ä¿®å¤å•å¼•å·ä¸ºåŒå¼•å·\n  s = s.replace(/'/g, '\"');\n  \n  // 3.4 ç§»é™¤æ§åˆ¶å­—ç¬¦\n  s = s.replace(/[\\x00-\\x1F\\x7F]/g, (char) => {\n    if (char === '\\n' || char === '\\r' || char === '\\t') return char;\n    return '';\n  });\n  \n  // 3.5 ä¿®å¤æ•°å€¼åé¢ç¼ºå°‘é€—å·çš„é—®é¢˜\n  s = s.replace(/(\\d)\\s*\\n\\s*\"/g, '$1,\\n\"');\n  \n  // 3.6 ä¿®å¤å¸ƒå°”å€¼/nullåç¼ºå°‘é€—å·\n  s = s.replace(/(true|false|null)\\s*\\n\\s*\"/gi, '$1,\\n\"');\n  \n  return s;\n}\n// ==============================================================\n\ntry {\n  let jsonStr = typeof aiOutput === 'string' ? aiOutput : JSON.stringify(aiOutput);\n  \n  // ç¬¬ä¸€æ¬¡å°è¯•ï¼šç›´æ¥è§£æ\n  let data;\n  try {\n    // åŸºç¡€æ¸…ç†\n    if (jsonStr.includes('```')) {\n      jsonStr = jsonStr.replace(/```json\\n?/g, '').replace(/```\\n?/g, '');\n    }\n    const start = jsonStr.indexOf('{');\n    const end = jsonStr.lastIndexOf('}') + 1;\n    if (start >= 0 && end > start) {\n      jsonStr = jsonStr.substring(start, end);\n    }\n    data = JSON.parse(jsonStr);\n  } catch (firstError) {\n    // ç¬¬äºŒæ¬¡å°è¯•ï¼šè‡ªåŠ¨ä¿®å¤åè§£æ\n    console.log('âš ï¸ First parse failed, attempting auto-repair...');\n    const repairedStr = repairJSON(jsonStr);\n    try {\n      data = JSON.parse(repairedStr);\n      console.log('âœ… JSON auto-repair successful!');\n    } catch (repairError) {\n      // ç¬¬ä¸‰æ¬¡å°è¯•ï¼šä½¿ç”¨æ­£åˆ™æå–å…³é”®å­—æ®µ\n      console.log('âš ï¸ Repair failed, extracting fields via regex...');\n      data = {\n        stock_name: (jsonStr.match(/\"stock_name\"\\s*:\\s*\"([^\"]+)\"/) || [])[1] || rawData.name,\n        analysis_summary: (jsonStr.match(/\"analysis_summary\"\\s*:\\s*\"([^\"]+)\"/) || [])[1] || 'è§£æéƒ¨åˆ†æˆåŠŸ',\n        trend_prediction: (jsonStr.match(/\"trend_prediction\"\\s*:\\s*\"([^\"]+)\"/) || [])[1] || 'ä¸­æ€§',\n        sentiment_score: parseInt((jsonStr.match(/\"sentiment_score\"\\s*:\\s*(\\d+)/) || [])[1]) || 50,\n        decision_type: (jsonStr.match(/\"decision_type\"\\s*:\\s*\"([^\"]+)\"/) || [])[1] || 'hold',\n        operation_advice: (jsonStr.match(/\"operation_advice\"\\s*:\\s*\"([^\"]+)\"/) || [])[1] || 'è§‚æœ›',\n        _repair_status: 'regex_fallback'\n      };\n    }\n  }\n  \n  const dashboard = data.dashboard || {};\n  \n  // Fallback Source: rawData > technical\n  const fallbackStopLoss = rawData.stop_loss || rawData.signal?.stop_loss || 0;\n  const fallbackTakeProfit = rawData.take_profit || rawData.signal?.take_profit || 0;\n  const fallbackSignal = rawData.signal_type || rawData.signal?.signal || 'è§‚æœ›';\n  \n  const result = {\n    date: new Date().toISOString().split('T')[0],\n    code: technical.code || rawData.code || \"unknown\",\n    market: technical.market || rawData.market || \"CN\",\n    name: data.stock_name || technical.name || rawData.name || rawData.code,\n    \n    signal_type: dashboard.core_conclusion?.signal_type || data.trend_prediction || fallbackSignal,\n    sentiment_score: data.sentiment_score || 50,\n    operation_advice: data.operation_advice || 'è§‚æœ›',\n    decision_type: data.decision_type || 'hold',\n    one_sentence: dashboard.core_conclusion?.one_sentence || data.analysis_summary || '',\n    \n    advice_no_position: dashboard.core_conclusion?.position_advice?.no_position || '',\n    advice_has_position: dashboard.core_conclusion?.position_advice?.has_position || '',\n    \n    entry_price: dashboard.battle_plan?.sniper_points?.ideal_buy || technical.support_level || 0,\n    stop_loss: dashboard.battle_plan?.sniper_points?.stop_loss || fallbackStopLoss,\n    take_profit: dashboard.battle_plan?.sniper_points?.take_profit || fallbackTakeProfit,\n    \n    current_price: technical.current_price,\n    atr14: technical.atr14,\n    bias_ma5: technical.bias_ma5,\n    rsi14: technical.rsi14,\n    volume_ratio: technical.volume_ratio,\n    ma_alignment: technical.ma_alignment,\n    \n    checklist: dashboard.battle_plan?.checklist?.join('\\n') || '',\n    risk_alerts: dashboard.intelligence?.risk_alerts?.join('\\n') || '',\n    news_summary: dashboard.intelligence?.sentiment_summary || '',\n    \n    raw_analysis: data,\n    _repair_status: data._repair_status || 'clean'  // æ ‡è®°ä¿®å¤çŠ¶æ€\n  };\n  \n  return [{ json: result }];\n  \n} catch (error) {\n  console.log('âŒ All parsing attempts failed:', error.message);\n  return [{\n    json: {\n      date: new Date().toISOString().split('T')[0],\n      code: technical?.code || 'ERROR',\n      market: technical?.market || rawData?.market || 'CN',\n      name: technical?.name || rawData?.name,\n      signal_type: 'è§£æå¤±è´¥',\n      one_sentence: 'AIè¿”å›æ ¼å¼å¼‚å¸¸ï¼Œå·²å°è¯•è‡ªåŠ¨ä¿®å¤ä½†å¤±è´¥',\n      current_price: technical?.current_price || 0,\n      bias_ma5: technical?.bias_ma5 || 0,\n      error: error.message,\n      raw_output: typeof aiOutput === 'string' ? aiOutput.substring(0, 500) : JSON.stringify(aiOutput).substring(0, 500),\n      _repair_status: 'failed'\n    }\n  }];\n}"
      },
      "id": "bbcffaa8-43d6-41bd-9918-130f22348744",
      "name": "è§£æAIåˆ†æç»“æœ",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        15936,
        7232
      ],
      "alwaysOutputData": true,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "resource": "bitable",
        "operation": "bitable:table:record:batchAdd",
        "app_toke": "RVghbRvYgacqs3s82qkcl83bn7e",
        "table_id": "tblvrNDNrjAZwBZc",
        "body": "={{\nJSON.stringify({\n  \"records\": [\n    {\n      \"fields\": {\n        \"æ—¥æœŸ\": new Date().getTime(),\n        \"å¸‚åœº\": $json.market || \"CN\",\n        \"ä»£ç \": $json.code || \"ERR\",\n        \"åç§°\": $json.name || \"Unknown\",\n        \"ä¿¡å·ç±»å‹\": $json.signal_type || \"æ— ä¿¡å·\",\n        \"ç»¼åˆè¯„åˆ†\": $json.sentiment_score || 0,\n        \"å†³ç­–ç±»å‹\": $json.decision_type || \"hold\",\n        \"æ“ä½œå»ºè®®\": $json.operation_advice || \"è§‚æœ›\",\n        \"æ ¸å¿ƒç»“è®º\": $json.one_sentence || \"\",\n        \"ç°ä»·\": $json.current_price || 0,\n        \"ä¹°å…¥ä»·\": String($json.entry_price || \"å¾…å®š\"),\n        \"æ­¢æŸä»·\": String($json.stop_loss || \"å¾…å®š\"),\n        \"ç›®æ ‡ä»·\": String($json.take_profit || \"å¾…å®š\"),\n        \"ATR\": $json.atr14 || 0,\n        \"ä¹–ç¦»ç‡\": $json.bias_ma5 || 0,\n        \"RSI\": $json.rsi14 || 0,\n        \"é‡æ¯”\": $json.volume_ratio || 0,\n        \"å‡çº¿å½¢æ€\": $json.ma_alignment || \"\",\n        \"è¶‹åŠ¿è¯„åˆ†\": $json.sentiment_score || 0,\n        \"å»ºè®®æ‰‹æ•°\": $json.raw_data?.risk_ctrl?.suggested_position || 0,\n        \"æ£€æŸ¥æ¸…å•\": $json.checklist || \"\",\n        \"é£é™©è­¦æŠ¥\": $json.risk_alerts || \"\",\n        \"æ–°é—»æ‘˜è¦\": $json.news_summary || \"\",\n        \"ç©ºä»“å»ºè®®\": $json.advice_no_position || \"\",\n        \"æŒä»“å»ºè®®\": $json.advice_has_position || \"\",\n        \"æ˜¯å¦ETF\": $json.raw_data?.is_etf ? \"æ˜¯\" : \"å¦\",\n        \"æ•°æ®æº\": $json.raw_data?.data_source || \"unknown\",\n        \"è§£æçŠ¶æ€\": $json._repair_status || \"clean\"\n      }\n    }\n  ]\n})\n}}"
      },
      "id": "8f8368cd-80ae-4321-8f68-14c492bc1604",
      "name": "å†™å…¥é£ä¹¦",
      "type": "n8n-nodes-feishu-lite.feishuNode",
      "typeVersion": 1,
      "position": [
        16112,
        7232
      ],
      "alwaysOutputData": true,
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetweenTries": 2000,
      "credentials": {
        "feishuCredentialsApi": {
          "id": "RcP0KB4O5l2Y95Bs",
          "name": "Feishu account 2"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// ã€V9.3 Enhanced Card Builderã€‘\nconst sourceNode = $('è§£æAIåˆ†æç»“æœ');\nlet sourceData = {};\n\nif (sourceNode && sourceNode.last()) {\n    sourceData = sourceNode.last().json;\n} else {\n    sourceData = $json; \n}\nconst root = sourceData; \n\nconst signal = root.signal_type || \"æ— ä¿¡å·\";\nconst score = root.sentiment_score || 0;\nconst advice = root.operation_advice || \"æš‚æ— å»ºè®®\";\nconst summary = root.one_sentence || \"æ— è¯¦ç»†ç»“è®º\";\nconst stockName = root.name || \"è‚¡ç¥¨\";\nconst code = root.code || \"\";\nconst currentPrice = root.current_price || 0;\nconst stopLoss = root.stop_loss || 0;\nconst takeProfit = root.take_profit || 0;\nconst decisionType = root.decision_type || 'hold';\n\n// ==================== V9.3 å¢å¼ºå¡ç‰‡é¢œè‰²é€»è¾‘ ====================\nlet color = 'grey';\nlet headerEmoji = 'ğŸ“Š';\nconst sigStr = signal.toString().toLowerCase();\n\n// é£ä¹¦å¡ç‰‡æ”¯æŒçš„é¢œè‰²: blue, wathet, turquoise, green, yellow, orange, red, carmine, violet, purple, indigo, grey\nif (sigStr.includes('å¼ºçƒˆä¹°å…¥') || sigStr.includes('strong buy') || score >= 85) {\n    color = 'turquoise';  // é’è‰² - å¼ºçƒˆä¹°å…¥ä¿¡å·\n    headerEmoji = 'ğŸš€';\n} else if (sigStr.includes('ä¹°å…¥') || sigStr.includes('buy') || decisionType === 'buy') {\n    color = 'green';      // ç»¿è‰² - æ™®é€šä¹°å…¥ä¿¡å·\n    headerEmoji = 'ğŸ“ˆ';\n} else if (sigStr.includes('å¼ºçƒˆå–å‡º') || sigStr.includes('strong sell') || score <= 15) {\n    color = 'carmine';    // æ·±çº¢ - å¼ºçƒˆå–å‡ºä¿¡å·\n    headerEmoji = 'âš ï¸';\n} else if (sigStr.includes('å–å‡º') || sigStr.includes('sell') || sigStr.includes('æ¸…ä»“') || decisionType === 'sell') {\n    color = 'red';        // çº¢è‰² - æ™®é€šå–å‡ºä¿¡å·\n    headerEmoji = 'ğŸ“‰';\n} else if (sigStr.includes('å‡ä»“') || sigStr.includes('reduce')) {\n    color = 'orange';     // æ©™è‰² - å‡ä»“ä¿¡å·\n    headerEmoji = 'âš¡';\n} else if (sigStr.includes('é£é™©') || sigStr.includes('warn') || sigStr.includes('è­¦å‘Š')) {\n    color = 'yellow';     // é»„è‰² - é£é™©è­¦å‘Š\n    headerEmoji = 'âš ï¸';\n} else if (sigStr.includes('è§‚æœ›') || sigStr.includes('wait') || sigStr.includes('hold') || decisionType === 'hold') {\n    color = 'blue';       // è“è‰² - è§‚æœ›/æŒæœ‰\n    headerEmoji = 'â³';\n} else if (sigStr.includes('è§£æå¤±è´¥') || sigStr.includes('error')) {\n    color = 'violet';     // ç´«è‰² - ç³»ç»Ÿé”™è¯¯\n    headerEmoji = 'âŒ';\n}\n\n// æ ¹æ®è¯„åˆ†å¾®è°ƒé¢œè‰²ï¼ˆè¦†ç›–ä¿¡å·é€»è¾‘ï¼‰\nif (score >= 80 && color === 'green') {\n    color = 'turquoise';  // é«˜åˆ†ç»¿è‰²å‡çº§ä¸ºé’è‰²\n}\nif (score <= 20 && color === 'red') {\n    color = 'carmine';    // ä½åˆ†çº¢è‰²å‡çº§ä¸ºæ·±çº¢\n}\n// ==============================================================\n\n// æ ¹æ®ä¿¡å·å¼ºåº¦é€‰æ‹©æŒ‰é’®æ ·å¼\nlet buttonType = 'default';\nif (color === 'turquoise' || color === 'green') {\n    buttonType = 'primary';\n} else if (color === 'carmine' || color === 'red') {\n    buttonType = 'danger';\n}\n\nconst cardContent = [\n  {\n    tag: 'div',\n    text: {\n      tag: 'lark_md',\n      content: `**${signal}** | è¯„åˆ†: **${score}**/100 | ${advice}`\n    }\n  },\n  { tag: 'hr' },\n  {\n    tag: 'div',\n    text: {\n      tag: 'lark_md',\n      content: `ğŸ’¡ **æ ¸å¿ƒç»“è®º**ï¼š\\n${summary}`\n    }\n  },\n  {\n    tag: 'div',\n    text: {\n      tag: 'lark_md',\n      content: `ğŸ’° ç°ä»·: **${currentPrice}** | æ­¢æŸ: ${stopLoss} | ç›®æ ‡: ${takeProfit}`\n    }\n  },\n  {\n    tag: 'action',\n    actions: [\n      {\n        tag: 'button',\n        text: { tag: 'plain_text', content: 'ğŸ“Š æŸ¥çœ‹å®Œæ•´æ•°æ®è¡¨' },\n        type: buttonType,\n        url: 'https://xcnf59usubzt.feishu.cn/base/RVghbRvYgacqs3s82qkcl83bn7e?table=tblvrNDNrjAZwBZc'\n      }\n    ]\n  },\n  {\n    tag: 'note',\n    elements: [\n      { tag: 'plain_text', content: `V9.3 Titan | ${stockName}(${code}) | Score: ${score}` }\n    ]\n  }\n];\n\nreturn {\n  json: {\n    card_color: color,\n    card_content: cardContent,\n    header_title: `${headerEmoji} ${stockName} æ¯æ—¥åˆ†æ`\n  }\n};"
      },
      "id": "a777eca7-a2db-4836-971d-965b8387b263",
      "name": "æ„å»ºé€šç”¨å¡ç‰‡",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        16320,
        7232
      ],
      "alwaysOutputData": true,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "resource": "message",
        "operation": "message:send",
        "receive_id_type": "user_id",
        "receive_id": "bg99a8dc",
        "msg_type": "interactive",
        "content": "={{\nJSON.stringify({\n  \"config\": {\n    \"wide_screen_mode\": true\n  },\n  \"header\": {\n    \"template\": $json.card_color,\n    \"title\": {\n      \"content\": $json.header_title,\n      \"tag\": \"plain_text\"\n    }\n  },\n  \"elements\": $json.card_content\n})\n}}"
      },
      "id": "8dc58221-43e4-4b54-9093-4915b5d3960a",
      "name": "å‘é€é€šç”¨æ¶ˆæ¯",
      "type": "n8n-nodes-feishu-lite.feishuNode",
      "typeVersion": 1,
      "position": [
        16512,
        7232
      ],
      "alwaysOutputData": true,
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetweenTries": 2000,
      "credentials": {
        "feishuCredentialsApi": {
          "id": "RcP0KB4O5l2Y95Bs",
          "name": "Feishu account 2"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "amount": 35,
        "unit": "seconds"
      },
      "id": "254f3595-4673-4e76-a738-ceee0565a0ae",
      "name": "å®‰æŠšåçˆ¬è™« (Wait 35s)",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1,
      "position": [
        16720,
        7232
      ],
      "webhookId": "e1ea52ec-d4ef-46a2-8df1-2bb2e1cf506f"
    }
  ],
  "pinData": {},
  "connections": {
    "å®šæ—¶è§¦å‘_å·¥ä½œæ—¥17:30(åŒ—äº¬æ—¶é—´)": {
      "main": [
        [
          {
            "node": "Global Context (API)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Global Context (API)": {
      "main": [
        [
          {
            "node": "è¯»å–è‚¡ç¥¨åˆ—è¡¨",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "è¯»å–è‚¡ç¥¨åˆ—è¡¨": {
      "main": [
        [
          {
            "node": "åˆå§‹åŒ–å¾ªç¯",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "åˆå§‹åŒ–å¾ªç¯": {
      "main": [
        [
          {
            "node": "æ‰‹å·¥å¾ªç¯æ§åˆ¶å™¨",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æ‰‹å·¥å¾ªç¯æ§åˆ¶å™¨": {
      "main": [
        [
          {
            "node": "Full Stack Analysis (API V9)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Full Stack Analysis (API V9)": {
      "main": [
        [
          {
            "node": "Tavilyæ–°é—»æœç´¢",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Tavilyæ–°é—»æœç´¢": {
      "main": [
        [
          {
            "node": "æ„å»ºAIæç¤ºè¯",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æ„å»ºAIæç¤ºè¯": {
      "main": [
        [
          {
            "node": "AIåˆ†æAgent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AIåˆ†æAgent": {
      "main": [
        [
          {
            "node": "è§£æAIåˆ†æç»“æœ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "è§£æAIåˆ†æç»“æœ": {
      "main": [
        [
          {
            "node": "å†™å…¥é£ä¹¦",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "å†™å…¥é£ä¹¦": {
      "main": [
        [
          {
            "node": "æ„å»ºé€šç”¨å¡ç‰‡",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æ„å»ºé€šç”¨å¡ç‰‡": {
      "main": [
        [
          {
            "node": "å‘é€é€šç”¨æ¶ˆæ¯",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "å‘é€é€šç”¨æ¶ˆæ¯": {
      "main": [
        [
          {
            "node": "å®‰æŠšåçˆ¬è™« (Wait 35s)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "å®‰æŠšåçˆ¬è™« (Wait 35s)": {
      "main": [
        [
          {
            "node": "æ‰‹å·¥å¾ªç¯æ§åˆ¶å™¨",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AIåˆ†æAgent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "34e09681-fb7e-4105-80b4-3eb20772e223",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "2f742d99bafc29685192c328e0fdaa64b8db6ce3b25050806eb96df939878538"
  },
  "id": "FJlupWOGyW53ZJoG",
  "tags": []
}